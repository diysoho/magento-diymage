<p class="diy control builder">
    <input type="hidden" name="<?php echo $this->getFieldName() ?>" id="<?php echo $this->getFieldId() ?>" value='<?php echo $this->getValue() ?>' />
    <label>Builder</label>
    <span class="help">Complete control over the layout of your page.  Add static blocks, widgets and manually remove preinserted blocks.  How freakin' cool is that?  Double click a block to toggle whether it should display or not.</span>
    <span id="builder_canvas"></span>
</p>

<script type="text/javascript" charset="utf-8">
<!--
    // @TODO: Make the elements appear in the sort order that we have stored.
    
    // This is the layout of the builder that we're getting from the block
    var references = {
        "left": <?php echo $this->getLayoutReferenceJson('left') ?>,
        "right": <?php echo $this->getLayoutReferenceJson('right') ?>,
        "content": <?php echo $this->getLayoutReferenceJson('content') ?>
    };
    
    // This is the json object containing the layout updates that we have previously saved
    // for this page.
    var updates = extractPresetLayoutUpdates();
    
    var name_map = <?php echo $this->getBlocksNiceNameMap() ?>;

    document.observe("dom:loaded", function () {
        // When the document loads, build our builder on the right hand side of the page
        updateLayoutBuilder();

        // Every time we change the layout of the page, update the builder layout
        $('layout').observe('change', function (e) {
            updateLayoutBuilder();
        });
    });
    
    // Update layout builder extracts the data we need to pass to drawLayoutBuilder()
    // which actually performs the rendering of the builder control.  The argument we'll
    // pass will be an array of objects, the objects have two properties, "key" and "label".
    // The key is the unique name identifying the section, and label is the descriptive name.
    function updateLayoutBuilder() {
        var layout = $('layout').getValue();
        var configuration = [];
        
        if (layout.match(/2/) && layout.match(/left/)) {
            configuration.push(
                {
                    key: "left",
                    label: "Left Column"
                },
                {
                    key: "content",
                    label: "Main"
                }
            );
        } else if (layout.match(/2/) && layout.match(/right/)) {
                configuration.push(
                    {
                        key: "content",
                        label: "Main"
                    },
                    {
                        key: "right",
                        label: "Right Column"
                    }
                );
        } else if (layout.match(/3/)) {
            configuration.push(
                {
                    key: "left",
                    label: "Left Column"
                },
                {
                    key: "content",
                    label: "Main"
                },
                {
                    key: "right",
                    label: "Right Column"
                }
            );
        } else {
            configuration.push(
                {
                    key: "content",
                    label: "Main"
                }
            );
        }
        
        drawLayoutBuilder(configuration);
    }
    
    // This function actually builds the HTML elements that make up the control, using the
    // configuration passed from updateLayoutBuilder(), and renders the control on the page.
    function drawLayoutBuilder(configuration) {
        var container = $j('#builder_canvas');
        var html = "";
        
        // Reset the content so we can append later
        container.html('');
        
        for ( var i = 0; i < configuration.length; i++ ) {
            var html = "";
            var container_id = "<?php echo $this->getFieldId() ?>_" + i;
            var refs = [];
                    
            html += "<div class='container' id='" + container_id + "'>";
                html += "<b>" + configuration[i].label + "</b>";
                html += "<ul class='container_canvas' id='container_" + configuration[i].key + "'>";
                
                    for ( var j = 0; j < references[configuration[i].key].length; j++ ) {
                        html += drawLayoutBlock(references[configuration[i].key][j].name, configuration[i].key);
                    }
                
                html += "</ul>";
            html += "</div>";
            container.append(html);
            
            // Build the input value once, just so we know it's in the correct format.
            buildLayoutUpdate(configuration[i].key);
            
            // Once we let go of the element, and have an updated structure, then we fire
            // of a command to update the hidden element.
            $j("#container_" + configuration[i].key).sortable({
                stop: function(e, ui) {
                    var ref = ui.item[0].getAttribute('reference');
                    buildLayoutUpdate(ref);
                }
            });
            
            // When a user double clicks on an element, we fire off a command to update the hidden
            // element, and we add a visual indicator that the block has been deleted through the
            // css class.
            $j("#container_" + configuration[i].key + " .block").bind("dblclick", function (e) {
                $j(this).toggleClass("deleted");
                buildLayoutUpdate(this.getAttribute('reference'));
            });
        }
    }
    
    // This function draws the individual block blocks within the control
    var block_id = 0;
    function drawLayoutBlock(name, reference) {
        var html = "";
        var css_class = "";
        var key = name;
        
        if (updates[reference] && $j.inArray(name, updates[reference].remove) != -1) {
            css_class = "deleted";
        }
        
        if (name_map[name]) {
            name = name_map[name];
        }
        
        // We add the reference so we know what the layout click event is for, and we can compile the update code.
        html += "<li class='block " + css_class + "' reference='" + reference + "' block_name='" + key + "' id='block_" + ++block_id + "'>";
            html += name;
        html += "</li>";
        
        return html;
    }
    
    // This function updates the hidden input field with a stringified JSON object
    // that represents the state of the builder control.
    function buildLayoutUpdate(section) {
        var new_update = {"remove": [], "sort_order": []};
        
        // Didn't use remove = .map() as I wasn't getting a proper result.
        $j("#container_" + section + " .block.deleted").each(function() {
            new_update.remove.push(this.getAttribute("block_name"));
        });

        var previous_block = "-";
        $j("#container_" + section + " .block").each(function () {
            
            if (!$j(this).hasClass("deleted")) {
                new_update.sort_order.push({
                    "name": this.getAttribute("block_name"),
                    "after": previous_block
                });
                
                // Update the last block's before block..
                var sort_order_length = new_update.sort_order.length;
                if (sort_order_length > 1) {
                    new_update.sort_order[sort_order_length - 2].before = this.innerHTML;
                }
            
                previous_block = this.innerHTML;
            }
        });
        
        var new_object = $j.parseJSON($j("#<?php echo $this->getFieldId() ?>").val());
        
        if (new_object == null) {
            new_object = {};
        }
        
        new_object[section] = new_update;

        $j("#<?php echo $this->getFieldId() ?>").val(JSON.stringify(new_object));
    }
    
    // This function gets around the problem that we appear to have where the
    // stringified object does not encode arrays properly, but keeps them as 
    // strings which is useless.
    function extractPresetLayoutUpdates() {
        var object = $j.parseJSON($j("#<?php echo $this->getFieldId() ?>").val());
        
        if (!object) {
            object = {};
        }

        return object;
    }
-->
</script>